<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>OCR 결과 목록</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="ocr.css">
</head>
<body>
  <div class="container" id="protectedContainer" style="display:none;">
    <div style="width:100%;text-align:right;margin-bottom:10px;">
      <a href="index.html" style="color:#007bff;font-size:15px;text-decoration:underline;font-weight:bold;">이미지 등록 페이지로 돌아가기</a>
    </div>
    <h2 style="font-size:18px;">저장된 OCR 결과 목록</h2>
    <div style="text-align:right;margin-bottom:8px;">
      <button id="deleteAllBtn" class="secondary" style="width:auto;padding:6px 18px;">전체 삭제</button>
    </div>
    <form id="historyForm">
      <div id="historyList"></div>
      <div style="text-align:right;margin:16px 0 0 0;">
        <button id="deleteSelectedBtn" type="button" class="secondary" style="width:auto;padding:6px 18px;display:none;">선택 삭제</button>
      </div>
    </form>
    <div style="width:100%;display:flex;justify-content:center;margin:40px 0 0 0;">
      <a id="downloadAllCsvBtn" href="#" style="display:none;padding:12px 28px;background:#28a745;color:#fff;border-radius:6px;font-size:17px;text-decoration:none;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.07);">CSV 전체 저장하기</a>
    </div>
    <div style="width:100%;display:flex;justify-content:center;margin:10px 0 0 0;">
      <button id="sendAllEmailBtn" style="display:none;padding:12px 28px;background:#007bff;color:#fff;border-radius:6px;font-size:17px;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.07);">CSV 전체 메일로 전송</button>
    </div>
  </div>
  <div id="pinPromptContainer" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;">
    <h2 style="font-size:20px;margin-bottom:18px;">히스토리 페이지 접근을 위해 6자리 PIN 번호를 입력하세요</h2>
    <input type="password" id="pinInput" maxlength="6" pattern="\d{6}" style="font-size:22px;text-align:center;width:160px;padding:10px;margin-bottom:16px;border-radius:6px;border:1px solid #ccc;" placeholder="PIN 번호">
    <button id="pinSubmitBtn" style="padding:10px 28px;font-size:18px;background:#007bff;color:#fff;border-radius:6px;font-weight:bold;border:none;cursor:pointer;">확인</button>
    <div id="pinErrorMsg" style="color:#d00;margin-top:12px;display:none;font-size:15px;">잘못된 PIN 번호입니다.</div>
  </div>
  <script src="ocr_history.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    // 6자리 PIN 번호 (예시: 123456, 실제 배포시 변경 권장)
    const VALID_PIN = '123456';
    const pinPromptContainer = document.getElementById('pinPromptContainer');
    const protectedContainer = document.getElementById('protectedContainer');
    const pinInput = document.getElementById('pinInput');
    const pinSubmitBtn = document.getElementById('pinSubmitBtn');
    const pinErrorMsg = document.getElementById('pinErrorMsg');
    pinSubmitBtn.onclick = function() {
      const pin = pinInput.value.trim();
      if (pin === VALID_PIN) {
        pinPromptContainer.style.display = 'none';
        protectedContainer.style.display = 'block';
        renderHistoryList();
      } else {
        pinErrorMsg.style.display = 'block';
        pinInput.value = '';
        pinInput.focus();
      }
    };
    pinInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') pinSubmitBtn.click();
    });

    // 체크박스 삭제 기능 추가
    function renderHistoryList() {
      let data = [];
      try {
        // localStorage에서 ocrHistory를 가져올 때, null이 아닌지 체크
        const raw = localStorage.getItem('ocrHistory');
        if (raw && raw !== 'undefined') {
          data = JSON.parse(raw);
        }
      } catch(e) { data = []; }
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
      if (!Array.isArray(data) || !data.length) {
        historyList.innerHTML = '<div style="text-align:center;color:#888;font-size:16px;">저장된 데이터가 없습니다.</div>';
        deleteSelectedBtn.style.display = 'none';
        return;
      }
      let html = '<ul style="list-style:none;padding:0;margin:0;">';
      data.forEach((item, idx) => {
        // item이 객체가 아니거나 text가 없으면 빈 문자열 처리
        const text = (item && typeof item === 'object' && 'text' in item) ? item.text : String(item);
        html += `<li style="display:flex;align-items:center;margin-bottom:12px;background:#f9f9f9;padding:10px 12px;border-radius:7px;">
          <input type="checkbox" class="historyCheck" value="${idx}" style="margin-right:12px;">
          <span style="flex:1;">${text ? text.replace(/\n/g,'<br>') : ''}</span>
        </li>`;
      });
      html += '</ul>';
      historyList.innerHTML = html;
      // 체크박스 변화에 따라 버튼 표시
      function updateDeleteBtn() {
        const checked = document.querySelectorAll('.historyCheck:checked').length;
        deleteSelectedBtn.style.display = checked ? 'inline-block' : 'none';
      }
      document.querySelectorAll('.historyCheck').forEach(chk => {
        chk.addEventListener('change', updateDeleteBtn);
      });
      updateDeleteBtn();
    }

    document.getElementById('deleteSelectedBtn').onclick = function() {
      let data = [];
      try {
        data = JSON.parse(localStorage.getItem('ocrHistory') || '[]');
      } catch(e) {}
      const checks = document.querySelectorAll('.historyCheck:checked');
      if (!checks.length) return;
      const idxs = Array.from(checks).map(chk => parseInt(chk.value));
      // idxs를 제외한 데이터만 남김
      data = data.filter((_, i) => !idxs.includes(i));
      localStorage.setItem('ocrHistory', JSON.stringify(data));
      renderHistoryList();
    };
  </script>
</body>
</html>
